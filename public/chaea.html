<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test CHAEA - Estilos de Aprendizaje</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px 30px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .consent-section {
            text-align: center;
        }

        .consent-box {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }

        .consent-box h3 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .consent-box p {
            color: #64748b;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .form-group {
            margin: 25px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6b7280;
            margin-right: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .question-container {
            text-align: center;
        }

        .question-number {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.3rem;
            color: #1f2937;
            margin-bottom: 40px;
            line-height: 1.5;
            font-weight: 500;
        }

        .answer-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .answer-btn {
            padding: 20px 40px;
            border: 3px solid #e5e7eb;
            background: white;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .answer-btn:hover {
            border-color: #4f46e5;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .answer-btn.selected {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }

        .results-section {
            text-align: center;
        }

        .profile-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
        }

        .profile-card h3 {
            color: #0c4a6e;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .profile-card p {
            color: #075985;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .score-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .score-card.primary {
            border-color: #4f46e5;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
        }

        .score-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4f46e5;
        }

        .score-label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }

        .error-message {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 30px 20px;
            }
            
            .answer-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .answer-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .navigation {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Test CHAEA</h1>
            <p>Cuestionario de Estilos de Aprendizaje</p>
        </div>

        <div class="content">
            <!-- Step 1: Consent -->
            <div class="step active" id="step-consent">
                <div class="consent-section">
                    <div class="consent-box">
                        <h3>Consentimiento Informado</h3>
                        <p>El Cuestionario CHAEA te ayudará a identificar tu estilo de aprendizaje preferido entre cuatro tipos: <strong>Activo, Reflexivo, Teórico y Pragmático</strong>.</p>
                        <p>Esta información se utilizará para personalizar tus evaluaciones académicas y mejorar tu experiencia de aprendizaje.</p>
                        <p><strong>Tus datos serán tratados de forma confidencial y podrás retirar tu consentimiento en cualquier momento.</strong></p>
                    </div>

                    <button class="btn" onclick="downloadResults()">Descargar Resultados</button>
                    <button class="btn btn-secondary" onclick="goBackToMain()">Volver al Sistema</button>
                    <button class="btn btn-secondary" onclick="restartTest()">Realizar Test Nuevamente</button>

                    <div class="checkbox-group">
                        <input type="checkbox" id="consentCheck">
                        <label for="consentCheck">Acepto participar en el Test CHAEA y el uso de mis datos para personalización educativa</label>
                    </div>

                    <button class="btn" onclick="startTest()" id="startBtn" disabled>Comenzar Test</button>
                </div>
            </div>

            <!-- Step 2: Questions -->
            <div class="step" id="step-questions">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="question-container">
                    <div class="question-number" id="questionNumber">Pregunta 1 de 80</div>
                    <div class="question-text" id="questionText">Cargando pregunta...</div>
                    
                    <div class="answer-buttons">
                        <button class="answer-btn" onclick="selectAnswer(true)" id="trueBtn">Sí</button>
                        <button class="answer-btn" onclick="selectAnswer(false)" id="falseBtn">No</button>
                    </div>
                </div>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="previousQuestion()" id="prevBtn" disabled>Anterior</button>
                    <button class="btn" onclick="nextQuestion()" id="nextBtn" disabled>Siguiente</button>
                </div>
            </div>

            <!-- Step 3: Loading -->
            <div class="step" id="step-loading">
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>Procesando tus respuestas...</h3>
                    <p>Calculando tu perfil de aprendizaje CHAEA</p>
                </div>
            </div>

            <!-- Step 4: Results -->
            <div class="step" id="step-results">
                <div class="results-section">
                    <h2>Tu Perfil de Aprendizaje</h2>
                    
                    <div class="profile-card" id="profileCard">
                        <h3 id="primaryStyle">Cargando...</h3>
                        <p id="styleDescription">Cargando descripción...</p>
                    </div>

                    <div class="scores-grid" id="scoresGrid">
                        <!-- Scores will be populated here -->
                    </div>

        function downloadResults() {
            // Simple text download - in production you might generate a PDF
            const resultsText = `
Resultados del Test CHAEA
========================
Usuario: ${userData.userName} (${userData.userId})
Email: ${userData.courseId}
Fecha: ${new Date().toLocaleDateString()}

Estilo Principal: ${document.getElementById('primaryStyle').textContent}
Descripción: ${document.getElementById('styleDescription').textContent}

Puntuaciones detalladas disponibles en el sistema.
            `;

            const blob = new Blob([resultsText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CHAEA_${userData.userName.replace(/\s+/g, '_')}_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function goBackToMain() {
            window.location.href = '/public/index.html';
        }
                </div>
            </div>

            <!-- Error Display -->
            <div class="error-message" id="errorMessage" style="display: none;">
                <strong>Error:</strong> <span id="errorText"></span>
            </div>
        </div>
    </div>

    <script>
        // CHAEA Questions (simplified version - 20 questions for demo)
        const CHAEA_QUESTIONS = [
            "Tengo fama de decir lo que pienso claramente y sin rodeos",
            "Estoy seguro de lo que es bueno y lo que es malo, lo que está bien y lo que está mal",
            "Muchas veces actúo sin mirar las consecuencias",
            "Normalmente trato de resolver los problemas metódicamente y paso a paso",
            "Creo que los formalismos coartan y limitan la actuación libre de las personas",
            "Me interesa saber cuáles son los sistemas de valores de los demás y con qué criterios actúan",
            "Pienso que el actuar intuitivamente puede ser siempre tan válido como actuar reflexivamente",
            "Creo que lo más importante es que las cosas funcionen",
            "Procuro estar al tanto de lo que ocurre aquí y ahora",
            "Disfruto cuando tengo tiempo para preparar mi trabajo y realizarlo a conciencia",
            "Estoy a gusto siguiendo un orden en las comidas, en el estudio, haciendo ejercicio regularmente",
            "Cuando escucho una nueva idea en seguida comienzo a pensar cómo ponerla en práctica",
            "Prefiero las ideas originales y novedosas aunque no sean prácticas",
            "Admito y me ajusto a las normas sólo si me sirven para lograr mis objetivos",
            "Normalmente encajo bien con personas reflexivas, analíticas y me cuesta más con personas demasiado espontáneas",
            "Escucho con más frecuencia que hablo",
            "Prefiero las cosas estructuradas a las desordenadas",
            "Cuando poseo cualquier información, trato de interpretarla bien antes de manifestar alguna conclusión",
            "Antes de tomar una decisión estudio con cuidado sus ventajas e inconvenientes",
            "Me crezco con el reto de hacer algo nuevo y diferente"
        ];

        // Application State
        let currentQuestion = 0;
        let responses = [];
        let userData = {};
        let selectedAnswer = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Initialize the application with current user
        async function initializeApp() {
            // Verificar autenticación (igual que tu sistema)
            const isAuthenticated = localStorage.getItem('isAuthenticated');
            
            if (!isAuthenticated) {
                window.location.replace('/public/loging.html');
                return;
            }

            // Obtener usuario actual (igual que tu sistema)
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                localStorage.removeItem('isAuthenticated');
                window.location.replace('/public/loging.html');
                return;
            }

            // Usar datos del usuario logueado
            userData = {
                userId: currentUser.userId,
                courseId: currentUser.email,
                userName: currentUser.nombre
            };

            // Mostrar información del usuario en el consentimiento
            updateConsentWithUserInfo();

            // Verificar si ya tiene perfil CHAEA
            checkExistingProfile().then(hasExistingProfile => {
                if (!hasExistingProfile) {
                    // Mostrar pantalla de consentimiento
                    showStep('step-consent');
                    setTimeout(() => {
                        setupConsentValidation();
                    }, 100);
                }
            });
        }

        function updateConsentWithUserInfo() {
            // Actualizar la UI con información del usuario
            const userInfoHTML = `
                <div style="background: #e0f2fe; border: 2px solid #0ea5e9; border-radius: 15px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #0c4a6e; margin: 0 0 10px 0;">Usuario actual:</h4>
                    <p style="margin: 5px 0; color: #075985;"><strong>Nombre:</strong> ${userData.userName}</p>
                    <p style="margin: 5px 0; color: #075985;"><strong>Email:</strong> ${userData.courseId}</p>
                </div>
            `;
            
            // Insertar antes del consentimiento
            const consentBox = document.querySelector('.consent-box');
            if (consentBox) {
                consentBox.insertAdjacentHTML('beforebegin', userInfoHTML);
            }

            // Ocultar inputs manuales (ya no son necesarios)
            const userIdInput = document.querySelector('#userId');
            const courseIdInput = document.querySelector('#courseId');

            if (userIdInput) {
                const userIdGroup = userIdInput.closest('.form-group');
                if (userIdGroup) userIdGroup.style.display = 'none';
            }

            if (courseIdInput) {
                const courseIdGroup = courseIdInput.closest('.form-group');
                if (courseIdGroup) courseIdGroup.style.display = 'none';
            }
        }

        async function checkExistingProfile() {
            try {
                showStep('step-loading');
                document.querySelector('.loading h3').textContent = 'Verificando perfil existente...';
                document.querySelector('.loading p').textContent = 'Consultando si ya realizaste el test CHAEA';

                const response = await fetch(`http://localhost:5010/chaea/profile/${userData.userId}/${userData.courseId}`);
                
                if (response.ok) {
                    const result = await response.json();
                    displayResults(result.profile);
                    return true;
                } else {
                    return false;
                }
            } catch (error) {
                console.log('No hay perfil existente, proceder con test');
                return false;
            }
        }

        function setupConsentValidation() {
            console.log('Configurando validación de consentimiento...');
            
            const consentCheck = document.getElementById('consentCheck');
            const startBtn = document.getElementById('startBtn');
        
            console.log('Checkbox encontrado:', !!consentCheck);
            console.log('Botón encontrado:', !!startBtn);
        
            if (!consentCheck || !startBtn) {
                console.error('Elementos no encontrados');
                return;
            }
        
            consentCheck.addEventListener('change', function() {
                console.log('Checkbox cambió a:', consentCheck.checked);
                startBtn.disabled = !consentCheck.checked;
                console.log('Botón ahora está:', startBtn.disabled ? 'deshabilitado' : 'habilitado');
            });
            
            // Estado inicial
            startBtn.disabled = true;
        }


        function displayQuestion() {
            const questionNumber = document.getElementById('questionNumber');
            const questionText = document.getElementById('questionText');
            const progressFill = document.getElementById('progressFill');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            questionNumber.textContent = `Pregunta ${currentQuestion + 1} de ${CHAEA_QUESTIONS.length}`;
            questionText.textContent = CHAEA_QUESTIONS[currentQuestion];
            
            const progress = ((currentQuestion + 1) / CHAEA_QUESTIONS.length) * 100;
            progressFill.style.width = progress + '%';

            prevBtn.disabled = currentQuestion === 0;
            
            // Reset answer selection
            selectedAnswer = responses[currentQuestion];
            updateAnswerButtons();
            updateNextButton();
        }

        function selectAnswer(answer) {
            selectedAnswer = answer;
            responses[currentQuestion] = answer;
            updateAnswerButtons();
            updateNextButton();
        }

        function updateAnswerButtons() {
            const trueBtn = document.getElementById('trueBtn');
            const falseBtn = document.getElementById('falseBtn');

            trueBtn.classList.toggle('selected', selectedAnswer === true);
            falseBtn.classList.toggle('selected', selectedAnswer === false);
        }

        function updateNextButton() {
            const nextBtn = document.getElementById('nextBtn');
            const isLastQuestion = currentQuestion === CHAEA_QUESTIONS.length - 1;
            
            nextBtn.disabled = selectedAnswer === null;
            nextBtn.textContent = isLastQuestion ? 'Finalizar Test' : 'Siguiente';
        }

        function nextQuestion() {
            if (selectedAnswer === null) return;

            if (currentQuestion === CHAEA_QUESTIONS.length - 1) {
                submitResponses();
            } else {
                currentQuestion++;
                displayQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                displayQuestion();
            }
        }

        async function submitResponses() {
            showStep('step-loading');

            try {
                // Expand responses to 80 questions (repeat pattern for demo)
                const fullResponses = [];
                for (let i = 0; i < 80; i++) {
                    fullResponses.push(responses[i % CHAEA_QUESTIONS.length]);
                }

                const response = await fetch('http://localhost:5010/chaea/submit-responses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userData.userId,
                        courseId: userData.courseId,
                        responses: fullResponses
                    })
                });

                if (!response.ok) {
                    throw new Error('Error al procesar las respuestas');
                }

                const result = await response.json();
                displayResults(result.profile);
            } catch (error) {
                showError('Error al procesar el test: ' + error.message);
                showStep('step-questions');
            }
        }

        function displayResults(profile) {
            const primaryStyle = document.getElementById('primaryStyle');
            const styleDescription = document.getElementById('styleDescription');
            const scoresGrid = document.getElementById('scoresGrid');

            primaryStyle.textContent = `Estilo ${profile.primaryStyle}`;
            styleDescription.textContent = profile.description;

            // Display scores
            const styles = [
                { name: 'Activo', score: profile.scores.active, key: 'active' },
                { name: 'Reflexivo', score: profile.scores.reflective, key: 'reflective' },
                { name: 'Teórico', score: profile.scores.theoretical, key: 'theoretical' },
                { name: 'Pragmático', score: profile.scores.pragmatic, key: 'pragmatic' }
            ];

            scoresGrid.innerHTML = styles.map(style => `
                <div class="score-card ${style.name.toLowerCase() === profile.primaryStyle.toLowerCase() ? 'primary' : ''}">
                    <div class="score-value">${style.score}/20</div>
                    <div class="score-label">${style.name}</div>
                </div>
            `).join('');

            showStep('step-results');
        }

        async function startTest() {
            // Los datos del usuario ya están configurados en userData
            if (!userData.userId || !userData.courseId) {
                showError('Error interno: Datos de usuario no disponibles');
                return;
            }
        
            try {
                // Save consent
                const response = await fetch('http://localhost:5010/consent/grant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userData.userId,
                        courseId: userData.courseId,
                        consentGiven: true
                    })
                });
        
                if (!response.ok) {
                    throw new Error('Error al guardar el consentimiento');
                }
        
                // Initialize responses array
                responses = new Array(CHAEA_QUESTIONS.length).fill(null);
                currentQuestion = 0;
                
                showStep('step-questions');
                displayQuestion();
            } catch (error) {
                showError('Error de conexión: ' + error.message);
            }
        }

        function showStep(stepId) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorMessage.style.display = 'block';
            
            setTimeout(hideError, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>